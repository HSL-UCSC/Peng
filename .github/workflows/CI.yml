name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  CARGO_TERM_COLOR: always

jobs:
  nix-build: # Job for Linux and macOS using Nix flakes
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix (with cleanup on macOS)
        if: runner.os == 'macOS'
        run: |
          # Clean up any existing nixbld users and groups
          set +e  # Don't fail on errors
          for i in {1..32}; do
            sudo dscl . -delete /Users/_nixbld$i 2>/dev/null
          done
          sudo dscl . -delete /Groups/nixbld 2>/dev/null
          set -e  # Re-enable failing on errors
          
          # Install Nix with determinate installer (non-interactive)
          curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm
          
          # Add Nix to PATH for subsequent steps
          echo "/nix/var/nix/profiles/default/bin" >> $GITHUB_PATH

      - name: Install Nix (Linux)
        if: runner.os == 'Linux'
        uses: cachix/install-nix-action@v26
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: peng-hsl
          # If you create a cachix cache, add the signing key as a repository secret
          # signingKey: '${{ secrets.CACHIX_SIGNING_KEY }}'
          # For now, just use public cache
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      # Use well-known public caches for common dependencies
      - name: Configure extra substituters
        run: |
          echo "extra-substituters = https://cache.nixos.org https://nix-community.cachix.org https://devenv.cachix.org" | sudo tee -a /etc/nix/nix.conf
          echo "extra-trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw=" | sudo tee -a /etc/nix/nix.conf

      - name: Install system dependencies (Linux only)
        if: runner.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y libudev-dev pkg-config

      - name: Enter Nix flake shell & Build
        run: |
          nix develop --command cargo build --verbose

      - name: Run Tests
        run: |
          nix develop --command cargo test --verbose

      - name: Check Formatting
        run: |
          nix develop --command cargo fmt -- --check

      - name: Run Clippy (Linting)
        run: |
          nix develop --command cargo clippy -- -D warnings

  windows-build:
    runs-on: windows-latest

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          # this checks out your main PQ repository on default branch
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout HyRL-protos branch
        uses: actions/checkout@v4
        with:
          repository: HSL-UCSC/Quad-RL
          path: hyrl-protos

      - name: Export OBSTACLE_AVOIDANCE_APIS
        shell: bash
        run: |
          echo "OBSTACLE_AVOIDANCE_APIS=${{ github.workspace }}/hyrl-protos" >> $GITHUB_ENV

      - name: Install Protobuf on Windows
        run: |
          choco install cmake --installargs '"ADD_CMAKE_TO_PATH=System"'
          choco install protoc
          protoc --version
          cmake --version

      - name: Build
        run: cargo build --verbose

      - name: Run tests
        run: cargo test --verbose

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run Clippy (Linting)
        run: cargo clippy -- -D warnings
